{
  "openapi": "3.0.1",
  "info": {
    "title": "repo-bridge",
    "version": "2.0.0"
  },
  "servers": [
    {
      "url": "https://repo-bridge.onrender.com"
    }
  ],
  "paths": {
    "/list": {
      "post": {
        "operationId": "listDirectory",
        "summary": "List files and directories in a GitHub repository.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Directory listing" }
        }
      }
    },

    "/read": {
      "post": {
        "operationId": "readFile",
        "summary": "Read a single file from a GitHub repository.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File contents" }
        }
      }
    },

    "/batchRead": {
      "post": {
        "operationId": "batchRead",
        "summary": "Read up to 25 files from one or more repositories in one call.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["files"],
                "properties": {
                  "files": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["repo", "path"],
                      "properties": {
                        "repo": { "type": "string" },
                        "path": { "type": "string" },
                        "branch": { "type": "string" }
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Batch read results" }
        }
      }
    },

    "/compare": {
      "post": {
        "operationId": "compareFiles",
        "summary": "Compare a file between two repositories or branches.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["source", "target"],
                "properties": {
                  "source": {
                    "type": "object",
                    "required": ["repo", "path"],
                    "properties": {
                      "repo": { "type": "string" },
                      "path": { "type": "string" },
                      "branch": { "type": "string" }
                    }
                  },
                  "target": {
                    "type": "object",
                    "required": ["repo"],
                    "properties": {
                      "repo": { "type": "string" },
                      "path": { "type": "string" },
                      "branch": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Comparison result" }
        }
      }
    },

    "/compareStructure": {
      "post": {
        "operationId": "compareStructure",
        "summary": "Compare directory structures between two repositories.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["source", "target"],
                "properties": {
                  "source": {
                    "type": "object",
                    "required": ["repo"],
                    "properties": {
                      "repo": { "type": "string" },
                      "path": { "type": "string" },
                      "branch": { "type": "string" }
                    }
                  },
                  "target": {
                    "type": "object",
                    "required": ["repo"],
                    "properties": {
                      "repo": { "type": "string" },
                      "path": { "type": "string" },
                      "branch": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Structure comparison result" }
        }
      }
    },

    "/apply": {
      "post": {
        "operationId": "writeFile",
        "summary": "Create or update a file in a GitHub repository.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path", "content", "message"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "content": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File written successfully" }
        }
      }
    },

    "/health": {
      "get": {
        "operationId": "healthCheck",
        "summary": "Check service status.",
        "responses": {
          "200": { "description": "Service status" }
        }
      }
    },

    "/metrics": {
      "get": {
        "operationId": "getMetrics",
        "summary": "Service observability: uptime, memory, version, GitHub rate-limit with warnings, last diagnostic snapshot.",
        "responses": {
          "200": { "description": "Service metrics" }
        }
      }
    },

    "/diagnose": {
      "post": {
        "operationId": "diagnoseRepo",
        "summary": "Run repository diagnostics.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Diagnostic report" }
        }
      }
    },

    "/patchReplace": {
      "post": {
        "operationId": "patchReplaceFile",
        "summary": "Apply search-and-replace operations to a file and commit.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path", "message", "operations"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" },
                  "operations": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["search", "replace"],
                      "properties": {
                        "search": { "type": "string" },
                        "replace": { "type": "string" }
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Patch applied and committed" },
          "409": { "description": "Search string not found" }
        }
      }
    },

    "/patchDiff": {
      "post": {
        "operationId": "patchDiffFile",
        "summary": "Apply a unified diff to a file and commit.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path", "message", "patch"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" },
                  "patch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Diff applied and committed" },
          "409": { "description": "Diff context mismatch" }
        }
      }
    },

    "/repoTree": {
      "post": {
        "operationId": "getRepoTree",
        "summary": "Get full recursive file tree for a repository with SHAs and sizes.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo"],
                "properties": {
                  "repo": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Recursive tree listing" }
        }
      }
    },

    "/deleteFile": {
      "post": {
        "operationId": "deleteFile",
        "summary": "Delete a file from a repository and commit the deletion.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path", "message"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File deleted" },
          "404": { "description": "File not found" }
        }
      }
    },

    "/updateFile": {
      "post": {
        "operationId": "updateFile",
        "summary": "Update a file with new content. Server handles diffing automatically.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path", "content", "message"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "content": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File updated" },
          "404": { "description": "File not found" }
        }
      }
    },

    "/listBranches": {
      "post": {
        "operationId": "listBranches",
        "summary": "List all branches for a repository with commit SHAs.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo"],
                "properties": {
                  "repo": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "List of branches" }
        }
      }
    },

    "/createBranch": {
      "post": {
        "operationId": "createBranch",
        "summary": "Create a new branch from an existing branch.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "branch"],
                "properties": {
                  "repo": { "type": "string" },
                  "branch": { "type": "string" },
                  "fromBranch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Branch created" },
          "422": { "description": "Branch already exists" }
        }
      }
    },

    "/createPR": {
      "post": {
        "operationId": "createPR",
        "summary": "Create a pull request to propose changes for review.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "title", "head"],
                "properties": {
                  "repo": { "type": "string" },
                  "title": { "type": "string" },
                  "head": { "type": "string" },
                  "base": { "type": "string" },
                  "body": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Pull request created" },
          "422": { "description": "Validation failed" }
        }
      }
    },

    "/copy": {
      "post": {
        "operationId": "copyFile",
        "summary": "Copy a file between repositories (or within the same repo). Reads source, writes to destination. Exact byte-for-byte copy.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["sourceRepo", "sourcePath", "destinationRepo"],
                "properties": {
                  "sourceRepo": { "type": "string" },
                  "sourcePath": { "type": "string" },
                  "destinationRepo": { "type": "string" },
                  "destinationPath": { "type": "string" },
                  "message": { "type": "string" },
                  "sourceBranch": { "type": "string" },
                  "destinationBranch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File copied successfully" },
          "404": { "description": "Source file not found" }
        }
      }
    },

    "/moveFile": {
      "post": {
        "operationId": "moveFile",
        "summary": "Move or rename a file in one call. Same-repo move is a rename. Also works across repos. Reads source, writes to destination, deletes source.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["sourceRepo", "sourcePath", "destinationPath"],
                "properties": {
                  "sourceRepo": { "type": "string" },
                  "sourcePath": { "type": "string" },
                  "destinationPath": { "type": "string" },
                  "destinationRepo": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File moved successfully" },
          "404": { "description": "Source file not found" }
        }
      }
    },

    "/dryRun": {
      "post": {
        "operationId": "dryRun",
        "summary": "Preview what a write would do without making any changes. Makes zero GitHub API calls. Safe to call anytime.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path", "content", "message"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "content": { "type": "string" },
                  "message": { "type": "string" },
                  "branch": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Preview of what would be applied" }
        }
      }
    },

    "/readLines": {
      "post": {
        "operationId": "readLines",
        "summary": "Read a file with line-accurate metadata. Normalizes line endings, returns blob SHA for drift detection, supports line range extraction.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "path"],
                "properties": {
                  "repo": { "type": "string" },
                  "path": { "type": "string" },
                  "branch": { "type": "string" },
                  "startLine": { "type": "integer" },
                  "endLine": { "type": "integer" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "File content with line metadata and blob SHA" }
        }
      }
    },

    "/blob": {
      "post": {
        "operationId": "getBlob",
        "summary": "Retrieve a raw blob by SHA. Uses Git Blobs API (supports files up to 100MB).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repo", "sha"],
                "properties": {
                  "repo": { "type": "string" },
                  "sha": { "type": "string" }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Decoded blob content with authoritative SHA" }
        }
      }
    },

    "/search": {
      "post": {
        "operationId": "searchRepoContent",
        "summary": "Search for content across repos using GitHub Code Search. Returns line-accurate results with blob SHA references.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["query", "repos"],
                "properties": {
                  "query": { "type": "string" },
                  "repos": {
                    "type": "array",
                    "items": { "type": "string" }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Search results with line-accurate references" }
        }
      }
    },

    "/symbols": {
      "post": {
        "operationId": "discoverSymbols",
        "summary": "Discover symbol definitions (functions, classes, interfaces) across repos with line-accurate references.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["repos"],
                "properties": {
                  "repos": {
                    "type": "array",
                    "items": { "type": "string" }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Discovered symbols with line references" }
        }
      }
    }
  }
}
